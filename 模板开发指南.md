# Cap4k DDD Codegen - Velocity 模板开发指南

## 一、文档概述

### 1.1 目标读者

本指南面向需要自定义代码生成模板的开发者,包括:

- 使用 cap4k-ddd-codegen-gradle-plugin 的项目开发者
- 希望扩展代码生成能力的架构师
- 需要定制企业级代码生成规范的技术团队

### 1.2 前置知识

- ✅ Java/Kotlin 基础
- ✅ Gradle 构建工具
- ✅ DDD(领域驱动设计)基本概念
- 🔧 Apache Velocity 模板语法(本文档会详细讲解)

### 1.3 文档结构

1. Velocity 语法入门
2. cap4k 上下文变量系统
3. 模板开发最佳实践
4. 实战案例:从零开发模板
5. 常见问题与调试技巧

---

## 二、Velocity 语法快速入门

### 2.1 基本语法

#### 2.1.1 变量输出

**基本变量引用**:

```velocity
## 标准输出
Hello, ${name}!

## 静默输出(变量不存在时输出空字符串,不报错)
Email: $!{email}

## 默认值(Velocity 2.0+)
${username.orElse("Guest")}
```

**示例**:

```velocity
## 上下文: {name: "Alice", email: null}
Hello, ${name}!           → Hello, Alice!
Email: $!{email}          → Email:
Email: ${email}           → 报错(严格模式下)
```

---

#### 2.1.2 属性和方法调用

**访问对象属性**:

```velocity
## 访问属性
${user.name}
${user.age}

## 调用方法
${user.getName()}
${user.isActive()}

## 链式调用
${user.getAddress().getCity()}
```

**cap4k 实例**:

```velocity
## Field 对象
${field.fieldName}        → 字段名
${field.javaType}         → Java 类型
${field.comment}          → 注释
${field.isPrimaryKey}     → 是否主键
```

---

#### 2.1.3 条件判断

**if-else 语句**:

```velocity
#if($user.age >= 18)
    Adult user
#elseif($user.age >= 13)
    Teenager
#else
    Child
#end
```

**逻辑运算符**:

```velocity
#if($user && $user.isActive())
    Active user
#end

#if($age > 18 && $age < 65)
    Working age
#end

#if(!$user.isBlocked())
    User is not blocked
#end
```

**cap4k 实例**:

```velocity
#if($field.isPrimaryKey)
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
#end

#if($field.nullable)
    @Column(name = "${field.columnName}", nullable = true)
#else
    @Column(name = "${field.columnName}", nullable = false)
#end
```

---

#### 2.1.4 循环遍历

**foreach 循环**:

```velocity
#foreach($item in $list)
    - $item
#end
```

**循环工具变量**:

```velocity
#foreach($field in $fields)
    Field ${foreach.count}: ${field.name}
    Index: ${foreach.index}
    #if($foreach.hasNext), #end
#end
```

| 变量               | 说明       | 起始值     |
|------------------|----------|---------|
| $foreach.count   | 循环计数     | 1       |
| $foreach.index   | 循环索引     | 0       |
| $foreach.hasNext | 是否有下一个元素 | boolean |
| $foreach.first   | 是否第一个元素  | boolean |
| $foreach.last    | 是否最后一个元素 | boolean |

**cap4k 实例**:

```velocity
## 生成字段定义
#foreach($field in $fields)
    /**
     * ${field.comment}
     */
    private ${field.javaType} ${field.fieldName};
#end

## 生成导入语句(去重、排序)
#foreach($import in $importList)
import ${import};
#end

## 生成逗号分隔列表
#foreach($entity in $entities)
${entity.name}#if($foreach.hasNext), #end
#end
```

---

#### 2.1.5 变量定义

**set 指令**:

```velocity
## 定义变量
#set($title = "User Management")
#set($version = 1.0)

## 计算表达式
#set($sum = $a + $b)
#set($fullName = "${firstName} ${lastName}")

## 定义集合
#set($colors = ["red", "green", "blue"])
#set($map = {"key1": "value1", "key2": "value2"})
```

**cap4k 实例**:

```velocity
## 标志变量
#set($hasDateField = false)
#foreach($field in $fields)
    #if($field.javaType == "Date" || $field.javaType == "LocalDateTime")
        #set($hasDateField = true)
    #end
#end

## 条件导入
#if($hasDateField)
import java.time.LocalDateTime;
#end
```

---

#### 2.1.6 宏定义

**macro 指令**:

```velocity
## 定义宏
#macro(field $type $name $comment)
    /**
     * ${comment}
     */
    private ${type} ${name};
#end

## 调用宏
#field("Long" "id" "用户ID")
#field("String" "name" "用户名")
```

**带默认值的宏**:

```velocity
#macro(getter $type $name $prefix = "get")
    public ${type} ${prefix}${name.substring(0,1).toUpperCase()}${name.substring(1)}() {
        return this.${name};
    }
#end

#getter("String" "name")          → getName()
#getter("boolean" "active" "is")  → isActive()
```

---

#### 2.1.7 模板引入

**parse 指令**(解析 Velocity 内容):

```velocity
#parse("vm/common/header.vm")
#parse("vm/common/imports.vm")
```

**include 指令**(原样插入,不解析):

```velocity
#include("vm/static/license.txt")
```

---

#### 2.1.8 注释

```velocity
## 单行注释(不会输出到结果)

#*
多行注释
不会输出到结果
*#

#**
文档注释
通常用于宏和指令的说明
*#
```

---

#### 2.1.9 转义

**转义 Velocity 语法**:

```velocity
## 方式1:使用反斜杠
\${notAVariable}      → ${notAVariable}

## 方式2:使用 #[[ ]]#
#[[
这里的 ${content} 不会被解析
${variable} 原样输出
]]#
```

**cap4k 特殊转义符号**:

```velocity
## cap4k 提供的转义符号
${symbol_pound}       → #
${symbol_dollar}      → $
${symbol_escape}      → \

## 使用场景:生成 Markdown 文档
${symbol_pound} Title
${symbol_pound}${symbol_pound} Subtitle
```

---

### 2.2 进阶语法

#### 2.2.1 范围循环

```velocity
#foreach($i in [1..5])
    Number: $i
#end

#foreach($i in [1..$max])
    Index: $i
#end
```

---

#### 2.2.2 字符串操作

```velocity
## 字符串拼接
#set($fullPath = "${basePackage}.${moduleName}.domain")

## 子串
${name.substring(0, 3)}

## 大小写转换
${name.toLowerCase()}
${name.toUpperCase()}

## 首字母大小写
${name.substring(0,1).toUpperCase()}${name.substring(1)}  ## 首字母大写
${name.substring(0,1).toLowerCase()}${name.substring(1)}  ## 首字母小写
```

---

#### 2.2.3 集合操作

```velocity
## 列表大小
Size: ${list.size()}

## 判空
#if($list && $list.size() > 0)
    List is not empty
#end

## 包含判断
#if($list.contains("item"))
    Found
#end
```

---

#### 2.2.4 数学运算

```velocity
## 算术运算
#set($sum = $a + $b)
#set($diff = $a - $b)
#set($product = $a * $b)
#set($quotient = $a / $b)
#set($remainder = $a % $b)

## 比较运算
#if($a == $b)
#if($a != $b)
#if($a > $b)
#if($a >= $b)
#if($a < $b)
#if($a <= $b)
```

---

## 三、Cap4k 上下文变量系统

### 3.1 变量分类

cap4k 提供的上下文变量分为以下几类:

| 类别   | 说明        | 示例变量                        |
|------|-----------|-----------------------------|
| 基础信息 | 项目和模块基本信息 | basePackage, moduleName     |
| 实体信息 | 数据库表和实体信息 | tableName, className        |
| 字段集合 | 字段列表和关联数据 | fields, entities            |
| 工具类  | 辅助工具对象    | StringUtils, DateUtils      |
| 转义符号 | 特殊字符转义    | symbol_pound, symbol_dollar |

---

### 3.2 基础信息变量

| 变量名                  | 类型     | 说明          | 示例                |
|----------------------|--------|-------------|-------------------|
| basePackage          | String | 项目基础包名      | com.only4.example |
| basePackage__as_path | String | 包名转路径(用于目录) | com/only4/example |
| moduleName           | String | 模块名称        | user              |
| aggregateName        | String | 聚合名称        | User              |
| author               | String | 代码作者        | cap4k-codegen     |
| datetime             | String | 生成日期时间      | 2024-12-21        |
| outputDir            | String | 输出目录        | src/main/java     |

**使用示例**:

```velocity
package ${basePackage}.${moduleName}.domain;

/**
 * ${aggregateName} Entity
 *
 * @author ${author}
 * @date ${datetime}
 */
public class ${className} {
    // ...
}
```

**生成结果**:

```java
package com.only4.example.user.domain;

/**
 * User Entity
 *
 * @author cap4k-codegen
 * @date 2024-12-21
 */
public class User {
    // ...
}
```

---

### 3.3 实体信息变量

| 变量名           | 类型      | 说明    | 示例     |
|---------------|---------|-------|--------|
| tableName     | String  | 数据库表名 | t_user |
| className     | String  | 实体类名  | User   |
| entityName    | String  | 实体名称  | User   |
| entityComment | String  | 实体注释  | 用户实体   |
| isRoot        | Boolean | 是否聚合根 | true   |
| idType        | String  | 主键类型  | Long   |
| idFieldName   | String  | 主键字段名 | id     |

**使用示例**:

```velocity
@Entity
@Table(name = "${tableName}")
@Aggregate(
    aggregate = "${aggregateName}",
    type = "entity",
    name = "${entityName}",
    root = ${isRoot}
)
public class ${className} extends AggregateRoot<${idType}> {
    // ...
}
```

---

### 3.4 字段集合变量

#### 3.4.1 fields 变量(字段列表)

**类型**: `List<Field>`

**Field 对象属性**:
| 属性名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| fieldName | String | Java 字段名(驼峰) | userId |
| columnName | String | 数据库列名(下划线) | user_id |
| javaType | String | Java 类型 | Long |
| jdbcType | String | JDBC 类型 | BIGINT |
| comment | String | 字段注释 | 用户ID |
| isPrimaryKey | Boolean | 是否主键 | true |
| nullable | Boolean | 是否可空 | false |
| length | Int | 字段长度 | 255 |
| precision | Int | 数值精度 | 10 |
| scale | Int | 小数位数 | 2 |
| defaultValue | String | 默认值 | 0 |

**使用示例**:

```velocity
#foreach($field in $fields)
    /**
     * ${field.comment}
     */
    #if($field.isPrimaryKey)
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    #end
    @Column(name = "${field.columnName}"#if($field.length), length = ${field.length}#end#if(!$field.nullable), nullable = false#end)
    private ${field.javaType} ${field.fieldName};

#end
```

**生成结果**:

```java
    /**
 * 用户ID
 */
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
@Column(name = "user_id", nullable = false)
private Long userId;

/**
 * 用户名
 */
@Column(name = "username", length = 50, nullable = false)
private String username;
```

---

#### 3.4.2 entities 变量(实体列表)

**类型**: `List<Entity>`

**Entity 对象属性**:
| 属性名 | 类型 | 说明 |
|--------|------|------|
| name | String | 实体名称 |
| className | String | 类名 |
| tableName | String | 表名 |
| comment | String | 注释 |
| isRoot | Boolean | 是否聚合根 |
| fields | List<Field> | 字段列表 |

**使用示例**:

```velocity
## 生成聚合文档
# ${aggregateName} 聚合

## 实体列表
#foreach($entity in $entities)
- **${entity.name}**: ${entity.comment} (表: ${entity.tableName})
#end
```

---

#### 3.4.3 importList 变量(导入包列表)

**类型**: `Set<String>`

**使用示例**:

```velocity
package ${basePackage}.${moduleName}.domain;

## 导入语句
#foreach($import in $importList)
import ${import};
#end

public class ${className} {
    // ...
}
```

---

### 3.5 工具类变量

#### 3.5.1 StringUtils(字符串工具)

**方法列表**:
| 方法 | 说明 | 示例 |
|------|------|------|
| capitalize(str) | 首字母大写 | capitalize("user") → "User" |
| uncapitalize(str) | 首字母小写 | uncapitalize("User") → "user" |
| camelToSnake(str) | 驼峰转下划线 | camelToSnake("userId") → "user_id" |
| snakeToCamel(str) | 下划线转驼峰 | snakeToCamel("user_id") → "userId" |

**使用示例**:

```velocity
## 生成 getter 方法
public ${field.javaType} get${StringUtils.capitalize(field.fieldName)}() {
    return this.${field.fieldName};
}

## 生成数据库列名
@Column(name = "${StringUtils.camelToSnake(field.fieldName)}")
```

---

#### 3.5.2 DateUtils(日期工具)

**方法列表**:
| 方法 | 说明 | 示例 |
|------|------|------|
| now() | 当前日期(yyyy-MM-dd) | "2024-12-21" |
| datetime() | 当前日期时间 | "2024-12-21 10:30:00" |
| year() | 当前年份 | "2024" |

---

#### 3.5.3 TypeUtils(类型工具)

**方法列表**:
| 方法 | 说明 | 示例 |
|------|------|------|
| isString(type) | 是否字符串类型 | true |
| isNumber(type) | 是否数字类型 | true |
| isDate(type) | 是否日期类型 | true |
| isBoolean(type) | 是否布尔类型 | true |

**使用示例**:

```velocity
#if($TypeUtils.isDate($field.javaType))
import java.time.LocalDateTime;
#end
```

---

### 3.6 转义符号变量

| 变量名           | 输出 | 用途          |
|---------------|----|-------------|
| symbol_pound  | #  | Markdown 标题 |
| symbol_dollar | $  | 字符串模板       |
| symbol_escape | \  | 转义字符        |

**使用示例**:

```velocity
${symbol_pound} ${aggregateName} 聚合

${symbol_pound}${symbol_pound} 概述
本聚合包含以下实体:
#foreach($entity in $entities)
- ${entity.name}
#end
```

**生成结果**:

```markdown
# User 聚合

## 概述

本聚合包含以下实体:

- User
- UserProfile
```

---

## 四、模板开发最佳实践

### 4.1 模板文件组织

#### 4.1.1 目录结构规范

**推荐结构**:

```
resources/vm/
├── entity/                 # 实体类模板
│   ├── entity.java.vm
│   ├── entity.kt.vm
│   └── enum.java.vm
├── aggregate/              # 聚合模板
│   ├── aggregate.md.vm
│   └── factory.java.vm
├── repository/             # 仓储模板
│   ├── repository.java.vm
│   └── jpa-impl.java.vm
├── common/                 # 公共模板
│   ├── header.vm           # 文件头
│   ├── imports.vm          # 导入语句
│   └── macros.vm           # 宏定义
└── custom/                 # 自定义模板
    └── my-template.vm
```

---

#### 4.1.2 模板命名规范

**格式**: `<用途>.<语言>.<后缀>.vm`

**示例**:

- `entity.java.vm` - Java 实体类模板
- `entity.kt.vm` - Kotlin 实体类模板
- `aggregate.md.vm` - 聚合 Markdown 文档模板
- `repository-interface.java.vm` - 仓储接口模板

---

### 4.2 代码风格规范

#### 4.2.1 缩进和格式

**规则**:

1. 使用 4 空格缩进
2. Velocity 指令独占一行
3. 块结束标记 `#end` 独占一行

**✅ 推荐**:

```velocity
#foreach($field in $fields)
    /**
     * ${field.comment}
     */
    private ${field.javaType} ${field.fieldName};

#end
```

**❌ 不推荐**:

```velocity
#foreach($field in $fields)/**${field.comment}*/private ${field.javaType} ${field.fieldName};#end
```

---

#### 4.2.2 注释规范

**规则**:

1. 模板文件头部添加说明注释
2. 复杂逻辑添加行内注释
3. 使用 `##` 注释,不使用 `#* *#`(避免干扰格式)

**示例**:

```velocity
##
## Cap4k DDD Codegen - Entity Template
## 用途: 生成 JPA 实体类
## 作者: cap4k-codegen
## 版本: 1.0
##

package ${basePackage}.${moduleName}.domain.entity;

## 导入基础类
import com.only4.cap4k.ddd.core.domain.aggregate.AggregateRoot;
import lombok.Data;

## 条件导入:日期类型
#if($hasDateField)
import java.time.LocalDateTime;
#end

/**
 * ${entityComment}
 */
@Data
public class ${className} extends AggregateRoot<${idType}> {
    ## 字段定义
    #foreach($field in $fields)
        ## 跳过基类字段
        #if(!$field.isSuperField)
    private ${field.javaType} ${field.fieldName};
        #end
    #end
}
```

---

#### 4.2.3 变量命名

**规则**:

1. 上下文变量使用驼峰命名
2. 局部变量使用小写+下划线
3. 布尔变量使用 `is/has` 前缀

**示例**:

```velocity
## 上下文变量(驼峰)
${className}
${moduleName}
${basePackage}

## 局部变量(下划线)
#set($has_date_field = false)
#set($import_list = [])

## 布尔变量(is/has 前缀)
#set($isRoot = true)
#set($hasChildren = false)
```

---

### 4.3 性能优化

#### 4.3.1 避免重复计算

**❌ 不推荐**:

```velocity
#foreach($field in $fields)
    #if($field.javaType.substring(0,1).toUpperCase() == "S")
        ## 每次循环都调用 substring 和 toUpperCase
    #end
#end
```

**✅ 推荐**:

```velocity
#foreach($field in $fields)
    #set($firstChar = $field.javaType.substring(0,1).toUpperCase())
    #if($firstChar == "S")
        ## 只计算一次
    #end
#end
```

---

#### 4.3.2 合理使用宏

**场景**: 重复代码片段

**示例**:

```velocity
## 定义宏
#macro(fieldAnnotation $field)
    #if($field.isPrimaryKey)
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    #end
    @Column(name = "${field.columnName}"#if(!$field.nullable), nullable = false#end)
#end

## 使用宏
#foreach($field in $fields)
    #fieldAnnotation($field)
    private ${field.javaType} ${field.fieldName};
#end
```

---

### 4.4 可维护性

#### 4.4.1 模块化设计

**拆分大模板**:

```velocity
## main.java.vm
#parse("vm/common/header.vm")
#parse("vm/common/imports.vm")

public class ${className} {
    #parse("vm/entity/fields.vm")
    #parse("vm/entity/methods.vm")
}
```

**优点**:

- 降低单文件复杂度
- 提高复用性
- 便于维护

---

#### 4.4.2 使用公共宏库

**创建 vm/common/macros.vm**:

```velocity
##
## 公共宏定义库
##

## 字段定义宏
#macro(field $type $name $comment)
    /**
     * ${comment}
     */
    private ${type} ${name};
#end

## Getter 方法宏
#macro(getter $type $name)
    public ${type} get${name.substring(0,1).toUpperCase()}${name.substring(1)}() {
        return this.${name};
    }
#end

## Setter 方法宏
#macro(setter $type $name)
    public void set${name.substring(0,1).toUpperCase()}${name.substring(1)}(${type} ${name}) {
        this.${name} = ${name};
    }
#end
```

**在模板中引用**:

```velocity
#parse("vm/common/macros.vm")

public class ${className} {
    #foreach($field in $fields)
        #field($field.javaType $field.fieldName $field.comment)
    #end

    #foreach($field in $fields)
        #getter($field.javaType $field.fieldName)
        #setter($field.javaType $field.fieldName)
    #end
}
```

---

## 五、实战案例:从零开发模板

### 5.1 需求分析

**目标**: 开发一个生成 Spring Data JPA Repository 接口的模板

**需求**:

1. 生成仓储接口,继承 `JpaRepository`
2. 添加自定义查询方法
3. 根据字段自动生成 `findBy` 方法
4. 支持分页和排序

---

### 5.2 设计模板结构

**模板文件**: `vm/repository/jpa-repository.java.vm`

**所需上下文变量**:

- `basePackage`: 基础包名
- `moduleName`: 模块名
- `className`: 实体类名
- `idType`: 主键类型
- `fields`: 字段列表
- `queryFields`: 可查询字段列表

---

### 5.3 编写模板

**Step 1: 文件头和包声明**:

```velocity
##
## Cap4k DDD Codegen - JPA Repository Template
## 用途: 生成 Spring Data JPA Repository 接口
##

package ${basePackage}.${moduleName}.repository;

import ${basePackage}.${moduleName}.domain.entity.${className};
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
```

---

**Step 2: 接口定义**:

```velocity
/**
 * ${className} 仓储接口
 *
 * @author ${author}
 * @date ${datetime}
 */
@Repository
public interface ${className}Repository extends JpaRepository<${className}, ${idType}> {
```

---

**Step 3: 生成查询方法**:

```velocity
    ## 根据可查询字段生成 findBy 方法
    #foreach($field in $queryFields)
        #if(!$field.isPrimaryKey)
    /**
     * 根据 ${field.comment} 查询
     */
    Optional<${className}> findBy${StringUtils.capitalize($field.fieldName)}(${field.javaType} ${field.fieldName});

        #end
    #end
```

---

**Step 4: 生成列表查询方法**:

```velocity
    ## 生成列表查询方法
    #foreach($field in $queryFields)
        #if($TypeUtils.isString($field.javaType))
    /**
     * 根据 ${field.comment} 模糊查询
     */
    @Query("SELECT e FROM ${className} e WHERE e.${field.fieldName} LIKE %:${field.fieldName}%")
    List<${className}> findBy${StringUtils.capitalize($field.fieldName)}Containing(@Param("${field.fieldName}") String ${field.fieldName});

        #end
    #end
```

---

**Step 5: 结束**:

```velocity
}
```

---

### 5.4 完整模板代码

**vm/repository/jpa-repository.java.vm**:

```velocity
##
## Cap4k DDD Codegen - JPA Repository Template
##

package ${basePackage}.${moduleName}.repository;

import ${basePackage}.${moduleName}.domain.entity.${className};
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * ${className} 仓储接口
 *
 * @author ${author}
 * @date ${datetime}
 */
@Repository
public interface ${className}Repository extends JpaRepository<${className}, ${idType}> {

    ## 根据可查询字段生成 findBy 方法
    #foreach($field in $queryFields)
        #if(!$field.isPrimaryKey)
    /**
     * 根据 ${field.comment} 查询
     */
    Optional<${className}> findBy${StringUtils.capitalize($field.fieldName)}(${field.javaType} ${field.fieldName});

        #end
    #end

    ## 生成列表查询方法
    #foreach($field in $queryFields)
        #if($TypeUtils.isString($field.javaType))
    /**
     * 根据 ${field.comment} 模糊查询
     */
    @Query("SELECT e FROM ${className} e WHERE e.${field.fieldName} LIKE %:${field.fieldName}%")
    List<${className}> findBy${StringUtils.capitalize($field.fieldName)}Containing(@Param("${field.fieldName}") String ${field.fieldName});

        #end
    #end
}
```

---

### 5.5 测试模板

**测试代码**:

```kotlin
@Test
fun `test jpa repository template`() {
    val context = mapOf(
        "basePackage" to "com.only4.example",
        "moduleName" to "user",
        "className" to "User",
        "idType" to "Long",
        "author" to "cap4k-codegen",
        "datetime" to "2024-12-21",
        "queryFields" to listOf(
            mapOf(
                "fieldName" to "username",
                "javaType" to "String",
                "comment" to "用户名",
                "isPrimaryKey" to false
            ),
            mapOf(
                "fieldName" to "email",
                "javaType" to "String",
                "comment" to "邮箱",
                "isPrimaryKey" to false
            )
        )
    )

    val velocityContext = VelocityContextBuilder.create(context)
    val result = VelocityTemplateRenderer.INSTANCE.render(
        "vm/repository/jpa-repository.java.vm",
        velocityContext
    )

    println(result)

    // 验证生成内容
    assertTrue(result.contains("interface UserRepository"))
    assertTrue(result.contains("findByUsername"))
    assertTrue(result.contains("findByUsernameContaining"))
}
```

---

### 5.6 生成结果

**生成的 UserRepository.java**:

```java
package com.only4.example.user.repository;

import com.only4.example.user.domain.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * User 仓储接口
 *
 * @author cap4k-codegen
 * @date 2024-12-21
 */
@Repository
public interface UserRepository extends JpaRepository<User, Long> {

    /**
     * 根据 用户名 查询
     */
    Optional<User> findByUsername(String username);

    /**
     * 根据 邮箱 查询
     */
    Optional<User> findByEmail(String email);

    /**
     * 根据 用户名 模糊查询
     */
    @Query("SELECT e FROM User e WHERE e.username LIKE %:username%")
    List<User> findByUsernameContaining(@Param("username") String username);

    /**
     * 根据 邮箱 模糊查询
     */
    @Query("SELECT e FROM User e WHERE e.email LIKE %:email%")
    List<User> findByEmailContaining(@Param("email") String email);
}
```

---

## 六、常见问题与调试技巧

### 6.1 语法错误调试

#### 问题1: 变量未定义

**错误信息**:

```
Velocity template syntax error in vm/entity/entity.java.vm:
  Unable to find resource 'fields'
```

**原因**: 上下文中缺少 `fields` 变量

**解决方案**:

```kotlin
// 检查上下文变量
val context = mapOf(
    "className" to "User",
    "fields" to listOf(...
)  // 确保 fields 变量存在
)
```

---

#### 问题2: 指令拼写错误

**错误模板**:

```velocity
#forech($field in $fields)  ## 拼写错误: forech
    ${field.name}
#end
```

**错误信息**:

```
Encountered "#forech" at line 1, column 1.
Was expecting one of:
    "#foreach" ...
```

**解决方案**: 修正拼写为 `#foreach`

---

#### 问题3: 括号不匹配

**错误模板**:

```velocity
#if($field.isPrimaryKey
    @Id
#end
```

**错误信息**:

```
Encountered ")" at line 2, column 1.
Was expecting: ")"
```

**解决方案**: 补全括号 `#if($field.isPrimaryKey)`

---

### 6.2 逻辑错误调试

#### 技巧1: 输出调试信息

```velocity
## 调试:输出变量值
DEBUG: className = ${className}
DEBUG: fields size = ${fields.size()}

#foreach($field in $fields)
    DEBUG: field[${foreach.index}] = ${field.fieldName} (${field.javaType})
#end
```

---

#### 技巧2: 条件判断调试

```velocity
## 调试:检查条件
#if($field.isPrimaryKey)
    DEBUG: This is primary key
#else
    DEBUG: This is NOT primary key
#end
```

---

#### 技巧3: 使用单元测试

```kotlin
@Test
fun `debug template rendering`() {
    val context = mapOf(
        "className" to "User",
        "fields" to emptyList<Any>()
    )

    val result = VelocityTemplateRenderer.INSTANCE.renderString(
        """
        Class: ${className}
        Fields: ${fields.size()}
        """.trimIndent(),
        VelocityContextBuilder.create(context)
    )

    println("=== Rendered Result ===")
    println(result)
}
```

---

### 6.3 性能问题调试

#### 问题: 模板渲染慢

**排查步骤**:

1. **检查循环嵌套深度**:

```velocity
## ❌ 三层嵌套,性能差
#foreach($aggregate in $aggregates)
    #foreach($entity in $aggregate.entities)
        #foreach($field in $entity.fields)
            ## ...
        #end
    #end
#end
```

2. **优化方案**: 减少嵌套,提前计算

```velocity
## ✅ 拆分循环
#foreach($aggregate in $aggregates)
    #set($totalFields = 0)
    #foreach($entity in $aggregate.entities)
        #set($totalFields = $totalFields + $entity.fields.size())
    #end
    Total fields: $totalFields
#end
```

3. **启用模板缓存**:

```kotlin
VelocityConfig(
    cacheEnabled = true  // 启用缓存
)
```

---

### 6.4 编码问题

#### 问题: 生成文件中文乱码

**原因**: 编码配置不一致

**解决方案**:

```kotlin
// 1. 配置 Velocity 编码
VelocityConfig(
    encoding = "UTF-8"
)

// 2. 确保模板文件是 UTF-8 编码
// 3. 写入文件时指定编码
File("output/User.java").writeText(result, Charsets.UTF_8)
```

---

## 七、进阶主题

### 7.1 自定义工具类

**需求**: 添加自定义工具类到模板上下文

**Step 1: 创建工具类**:

```kotlin
// velocity/tools/CodeUtils.kt
object CodeUtils {
    /**
     * 生成 getter 方法名
     */
    fun getterName(fieldName: String, javaType: String): String {
        val prefix = if (javaType == "Boolean" || javaType == "boolean") "is" else "get"
        return prefix + fieldName.replaceFirstChar { it.uppercase() }
    }

    /**
     * 生成 setter 方法名
     */
    fun setterName(fieldName: String): String {
        return "set" + fieldName.replaceFirstChar { it.uppercase() }
    }

    /**
     * 判断是否基础类型
     */
    fun isPrimitive(javaType: String): Boolean {
        return javaType in setOf("int", "long", "double", "float", "boolean", "char", "byte", "short")
    }
}
```

---

**Step 2: 注册到上下文**:

```kotlin
val velocityContext = VelocityContextBuilder()
    .putAll(context)
    .putTool("CodeUtils", CodeUtils)  // 注册工具类
    .build()
```

---

**Step 3: 在模板中使用**:

```velocity
#foreach($field in $fields)
    ## 生成 getter
    public ${field.javaType} ${CodeUtils.getterName($field.fieldName, $field.javaType)}() {
        return this.${field.fieldName};
    }

    ## 生成 setter
    #if(!$CodeUtils.isPrimitive($field.javaType))
    public void ${CodeUtils.setterName($field.fieldName)}(${field.javaType} ${field.fieldName}) {
        this.${field.fieldName} = ${field.fieldName};
    }
    #end
#end
```

---

### 7.2 条件模板加载

**需求**: 根据配置动态选择模板

**实现**:

```kotlin
fun selectTemplate(useKotlin: Boolean): String {
    return if (useKotlin) {
        "vm/entity/entity.kt.vm"
    } else {
        "vm/entity/entity.java.vm"
    }
}

val templatePath = selectTemplate(project.hasProperty("kotlin"))
val result = VelocityTemplateRenderer.INSTANCE.render(
    templatePath,
    velocityContext
)
```

---

### 7.3 模板继承

**需求**: 创建模板基类,子模板继承公共部分

**base-entity.java.vm**(基类模板):

```velocity
package ${basePackage}.${moduleName}.domain.entity;

import lombok.Data;

/**
 * ${className}
 */
@Data
public class ${className} {
    ## 基础字段
    private Long id;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    ## 子模板扩展点
    #parse("${extensionTemplate}")
}
```

---

**user-entity-extension.vm**(扩展模板):

```velocity
## 用户特有字段
private String username;
private String email;
private String password;
```

---

**使用**:

```kotlin
val context = mapOf(
    "basePackage" to "com.example",
    "moduleName" to "user",
    "className" to "User",
    "extensionTemplate" to "vm/entity/user-entity-extension.vm"
)
```

---

## 八、模板库参考

### 8.1 内置模板列表

| 模板文件               | 用途         | 输出文件                          |
|--------------------|------------|-------------------------------|
| entity.java.vm     | JPA 实体类    | {ClassName}.java              |
| entity.kt.vm       | Kotlin 实体类 | {ClassName}.kt                |
| enum.java.vm       | 枚举类        | {EnumName}.java               |
| aggregate.md.vm    | 聚合文档       | {AggregateName}_aggregate.md  |
| factory.java.vm    | 工厂类        | {ClassName}Factory.java       |
| repository.java.vm | 仓储接口       | {ClassName}Repository.java    |
| jpa-impl.java.vm   | JPA 仓储实现   | Jpa{ClassName}Repository.java |
| schema.md.vm       | Schema 文档  | schema.md                     |

---

### 8.2 模板下载

**官方模板库**: https://github.com/only4/cap4k-templates

**目录结构**:

```
cap4k-templates/
├── java/
│   ├── jpa/
│   ├── mybatis/
│   └── jdbc/
├── kotlin/
│   └── coroutines/
├── docs/
│   ├── markdown/
│   └── asciidoc/
└── custom/
    └── enterprise/
```

---

## 九、总结

### 9.1 关键要点

1. ✅ Velocity 语法简洁强大,支持条件、循环、宏
2. ✅ cap4k 提供完整的上下文变量系统
3. ✅ 模板开发遵循规范,提高可维护性
4. ✅ 使用工具类增强模板能力
5. ✅ 充分测试,确保模板质量

---

### 9.2 学习路径

**初级** (1-2天):

- ✅ 掌握 Velocity 基本语法
- ✅ 了解 cap4k 上下文变量
- ✅ 编写简单模板(实体类、文档)

**中级** (3-5天):

- ✅ 掌握进阶语法(宏、#parse)
- ✅ 使用工具类
- ✅ 编写复杂模板(仓储、服务层)

**高级** (1-2周):

- ✅ 自定义工具类
- ✅ 模板优化和性能调优
- ✅ 构建企业级模板库

---

### 9.3 参考资源

**官方文档**:

- **Velocity User Guide**: https://velocity.apache.org/engine/2.3/user-guide.html
- **VTL Reference**: https://velocity.apache.org/engine/2.3/vtl-reference.html

**社区资源**:

- **Cap4k 模板库**: https://github.com/only4/cap4k-templates
- **示例项目**: https://github.com/only4/cap4k-examples

**书籍推荐**:

- 《Apache Velocity 实战》
- 《代码生成器设计与实现》

---

**文档版本**: v1.0
**最后更新**: 2024-12-21
**作者**: cap4k-codegen team

---

## 附录

### A. Velocity 快速参考卡

**变量**:

```velocity
${variable}              ## 输出变量
$!{variable}             ## 静默输出
${variable.property}     ## 访问属性
${variable.method()}     ## 调用方法
```

**条件**:

```velocity
#if($condition)...#end
#if($condition)...#else...#end
#if($c1)...#elseif($c2)...#else...#end
```

**循环**:

```velocity
#foreach($item in $list)..#end
$foreach.count           ## 1-based
$foreach.index           ## 0-based
$foreach.hasNext
```

**宏**:

```velocity
#macro(name $param)...#end
#name($arg)              ## 调用
```

**引入**:

```velocity
#parse("file.vm")        ## 解析
#include("file.txt")     ## 原样包含
```

---

### B. Cap4k 上下文变量速查

| 变量          | 类型           | 说明   |
|-------------|--------------|------|
| basePackage | String       | 基础包名 |
| moduleName  | String       | 模块名  |
| className   | String       | 类名   |
| tableName   | String       | 表名   |
| fields      | List<Field>  | 字段列表 |
| entities    | List<Entity> | 实体列表 |
| author      | String       | 作者   |
| datetime    | String       | 日期时间 |

---

### C. 常见错误速查

| 错误                            | 原因       | 解决         |
|-------------------------------|----------|------------|
| Unable to find resource 'var' | 变量未定义    | 检查上下文      |
| Encountered "#ned"            | 拼写错误     | 改为 #end    |
| Was expecting: ")"            | 括号不匹配    | 补全括号       |
| NullPointerException          | 变量为 null | 使用 $!{var} |

---

**END OF DOCUMENT**
